<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST CHAIN v3.4</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Courier New', monospace; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .header-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; width: 100%; max-width: 600px; justify-content: space-between; }
        h1 { font-size: 1.8rem; text-shadow: 0 0 10px #00ff41; margin: 0; }
        .ghost-ascii { white-space: pre; font-family: monospace; font-size: 11px; line-height: 1; color: #00ff41; margin: 0; }
        #log { border: 1px solid #00ff41; width: 100%; max-width: 600px; height: 50vh; overflow-y: auto; padding: 15px; background: #000; margin-bottom: 20px; box-sizing: border-box; }
        .block { border-left: 3px solid #00ff41; margin: 12px 0; padding: 12px; background: #0a0a0a; word-wrap: break-word; }
        .block-meta { margin-top: 8px; display: flex; gap: 15px; font-size: 0.75em; color: #444; border-top: 1px solid #111; padding-top: 4px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 600px; }
        input { background: #000; color: #00ff41; border: 1px solid #00ff41; padding: 15px; font-size: 18px; outline: none; }
        button { background: #00ff41; color: #000; border: none; padding: 18px; cursor: pointer; font-weight: bold; font-size: 18px; }
        .system { color: #888; font-size: 0.8em; text-align: center; margin: 10px 0; }
        .hidden { display: none; }
        #debug-text { width: 100%; max-width: 600px; color: orange; font-size: 12px; margin-top: 10px; height: 60px; overflow-y: auto; border: 1px solid #222; padding: 5px;}
    </style>
</head>
<body>

    <div class="header-container">
        <h1>GHOST_CHAIN</h1>
        <pre class="ghost-ascii">
   .-.
  |oo |
  |   |
  '^^^'</pre>
    </div>

    <div id="setup" style="width: 100%; max-width: 600px;">
        <div class="input-group">
            <input type="text" id="room-name" placeholder="Room Name">
            <input type="password" id="cipher-key" placeholder="Secret Key">
            <button onclick="boot()">INITIALIZE_GHOST</button>
        </div>
    </div>

    <div id="terminal" class="hidden" style="width: 100%; max-width: 600px;">
        <div id="log"></div>
        <div class="input-group">
            <input type="text" id="data-input" placeholder="Message...">
            <button onclick="mine()">MINE</button>
        </div>
        <p id="peer-status" class="system">Searching for peers...</p>
    </div>
    
    <div id="debug-text">> Waiting...</div>

    <script>
        let blockchain = [];
        let peer = null;
        let connections = [];
        let mySlot = 0;
        let baseId = "";

        function debug(msg) { document.getElementById('debug-text').innerHTML += `<br>> ${msg}`; }

        async function boot() {
            const room = document.getElementById('room-name').value;
            const key = document.getElementById('cipher-key').value;
            if(!room || !key) return;

            // Generate a unique base string for this specific room/key
            const encoder = new TextEncoder();
            const data = encoder.encode(room + key);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            baseId = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 10);

            findAvailableSlot();
        }

        function findAvailableSlot() {
            mySlot++;
            if(mySlot > 10) { debug("Room full."); return; }

            const testId = `gc-${baseId}-${mySlot}`;
            peer = new Peer(testId, {
                config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]}
            });

            peer.on('open', (id) => {
                debug(`Joined as Slot ${mySlot}`);
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('terminal').classList.remove('hidden');
                autoConnect();
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    findAvailableSlot(); // Slot taken, try next
                } else {
                    debug("Peer Error: " + err.type);
                }
            });

            peer.on('connection', setupConn);
        }

        function autoConnect() {
            // Attempt to connect to slots 1 through 5 (excluding self)
            for(let i=1; i<=5; i++) {
                if(i === mySlot) continue;
                const targetId = `gc-${baseId}-${i}`;
                const conn = peer.connect(targetId);
                setupConn(conn);
            }
            document.getElementById('peer-status').innerText = "MESH ACTIVE - SLOT " + mySlot;
        }

        function setupConn(conn) {
            conn.on('open', () => {
                if (connections.find(c => c.peer === conn.peer)) return;
                connections.push(conn);
                debug(`Linked to ${conn.peer.slice(-1)}`);
                conn.send({ type: 'SYNC', chain: blockchain });
            });

            conn.on('data', data => {
                if(data.chain && data.chain.length > blockchain.length) {
                    blockchain = data.chain;
                    render();
                }
            });
        }

        function mine() {
            const val = document.getElementById('data-input').value;
            if(!val) return;
            blockchain.push({ 
                index: blockchain.length, 
                data: val, 
                ts: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                sender: mySlot 
            });
            connections.forEach(c => c.send({ type: 'CHAIN', chain: blockchain }));
            render();
            document.getElementById('data-input').value = "";
        }

        function render() {
            document.getElementById('log').innerHTML = blockchain.map(b => `
                <div class="block">
                    <b>BLOCK_${b.index}:</b> ${b.data}
                    <div class="block-meta">
                        <span>GHOST_0${b.sender}</span>
                        <span>${b.ts}</span>
                    </div>
                </div>`).join('');
            const log = document.getElementById('log');
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>