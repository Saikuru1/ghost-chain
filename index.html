<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST CHAIN v3.5</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .ghost-ascii { white-space: pre; font-size: 11px; line-height: 1; margin-bottom: 20px; color: #00ff41; text-shadow: 0 0 5px #00ff41; }
        #log { border: 1px solid #00ff41; width: 100%; max-width: 500px; height: 50vh; overflow-y: auto; padding: 15px; background: #000; margin-bottom: 20px; }
        .block { border-left: 2px solid #00ff41; margin: 10px 0; padding: 10px; background: #0a0a0a; }
        .block-meta { display: flex; justify-content: space-between; font-size: 0.7em; color: #444; margin-top: 5px; border-top: 1px solid #111; }
        input { background: #000; color: #00ff41; border: 1px solid #00ff41; padding: 15px; width: 100%; box-sizing: border-box; margin-bottom: 10px; outline: none; }
        button { background: #00ff41; color: #000; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; }
        .hidden { display: none; }
        #status { font-size: 0.8em; color: orange; margin-top: 10px; }
    </style>
</head>
<body>

    <pre class="ghost-ascii">
   .-.
  |oo |
  |   |
  '^^^'</pre>

    <div id="setup" style="width: 100%; max-width: 400px;">
        <input type="text" id="room" placeholder="ROOM_NAME">
        <input type="password" id="key" placeholder="SECRET_KEY">
        <button onclick="boot()">INITIALIZE_GHOST</button>
    </div>

    <div id="terminal" class="hidden" style="width: 100%; max-width: 500px;">
        <div id="log"></div>
        <input type="text" id="msg" placeholder="Type message..." onkeypress="if(event.key==='Enter') mine()">
        <button onclick="mine()">MINE_BLOCK</button>
        <div id="status">Connecting to mesh...</div>
    </div>

    <script>
        let blockchain = [], connections = [], peer = null, myId = "";

        async function boot() {
            const room = document.getElementById('room').value;
            const key = document.getElementById('key').value;
            if(!room || !key) return;

            // Simple hash to create a shared "Address Space"
            const hash = Array.from(new Uint8Array(await crypto.subtle.digest('SHA-256', new TextEncoder().encode(room + key))))
                         .map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 8);
            
            // Try slots 1-5
            trySlot(hash, 1);
        }

        function trySlot(hash, slot) {
            const testId = `gc-${hash}-${slot}`;
            const p = new Peer(testId, { config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }});
            
            p.on('open', (id) => {
                peer = p; myId = id;
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('terminal').classList.remove('hidden');
                document.getElementById('status').innerText = `LOCAL_NODE: SLOT_${slot}`;
                
                // Auto-dial other potential slots
                for(let i=1; i<=5; i++) {
                    if(i !== slot) setupConn(peer.connect(`gc-${hash}-${i}`));
                }
            });

            p.on('error', (err) => {
                if(err.type === 'unavailable-id') trySlot(hash, slot + 1);
                else console.error(err);
            });

            p.on('connection', setupConn);
        }

        function setupConn(conn) {
            conn.on('open', () => {
                connections.push(conn);
                document.getElementById('status').innerText = `MESH_ACTIVE: ${connections.length} PEERS`;
                conn.send({ type: 'SYNC', chain: blockchain });
            });
            conn.on('data', data => {
                if(data.chain && data.chain.length > blockchain.length) {
                    blockchain = data.chain;
                    render();
                }
            });
        }

        function mine() {
            const input = document.getElementById('msg');
            if(!input.value) return;
            blockchain.push({
                data: input.value,
                sender: myId.slice(-1),
                ts: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            connections.forEach(c => c.send({ type: 'CHAIN', chain: blockchain }));
            render();
            input.value = "";
        }

        function render() {
            document.getElementById('log').innerHTML = blockchain.map((b, i) => `
                <div class="block">
                    <b>BLOCK_${i}:</b> ${b.data}
                    <div class="block-meta"><span>GHOST_0${b.sender}</span><span>${b.ts}</span></div>
                </div>`).join('');
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }
    </script>
</body>
</html>